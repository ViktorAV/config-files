# Управление службами с помощью systemd
Когда включается компьютер, запускаются сотни процессов, чтобы их увидеть нажмите `Esc`.
До появления __systemd__ использовались старые системы инициализации
- Unix System V (SysV init)
- BSD init
- Linux Standard Base init (LSB)
Однако есть ряд дистрибутивов продолжающих использовать старые системы инициализации.
Система инициализации __systemd__ поддерживает
- Полноценное управление службами от запуска до завершения.
- Запуск процессов при загрузке и после.
- Завершение служб.
- Управление системным журналом.
- Автоматическое монтирование файловых систем.
- Автоматическое разрешение зависимостей служб.
- Управление устройствами.
- Управление сетевыми подключениями.
- Управление входом в систему.
- И множество других задач.
Все эти возможности выполняют процессы, доступные и без __systemd__.
Система __systemd__ пытается уменьшить время загрузки и более эффективно распределять
системные ресурсы, запуская процессы одновременно и параллельно и инициализируя
только необходимые службы, откладывая запуск других служб на период после загрузки.
Двоичные файлы __systemd__ написаны на языке __C__.
Если служба не имеет файла конфигурации __systemd__ система пытается отыскать __SysV__. (init)
Служебные файлы __systemd__ более просты и понятны, в отличие от старых аналогов.

## Проверка использования systemd в вашем дистрибутиве Linux
Если в вашей системе имеется каталог _/run/systemd/system_ значит вы используете __systemd__.
Следующая команда выводит используемую систему инициализации
```bin
stat /sbin/init
```
Псевдофайловая система _/proc_ является интерфейсом к ядру __Linux__ она содержит информацию
о текущем состоянии системы. Она называется псевдофайловой поскольку она существует в
оперативной памяти.
```bash
sudo stat /proc/1/exe # этот процесс ссылается на systemd
```
Следующая команда выводит название активной системы инициализации
```bash
cat /proc/1/comm
```
Также систему инициализации можно узнать от первого запущенного процесса
```bash
ps -p 1
```

## Процесс с PID 1 - родоначальник всех процессов
Это первый процесс который запускается в системе и он запускает все остальные процессы.
Процессы - это экземпляр запущенной программы.
Каждая задача в системе Linux - это процесс.
Процессы могут создавать независимые копии самих себя, т.е. могут ветвиться.
Ветви процессов называются потомками, а оригинал - родителем или предком.
Каждый потомок получает свой PID и набор системных ресурсов.
Потоки выполнения - это легковесные процессы, выполняющиеся параллельно, они используют
общие системные ресурсы.
Процессы могут работать в фоновом режиме, такие процессы называют службами или демонами,
и их имена обычно заканчиваются на __D__. (httpd sshd systemd)
Вывести список всех процессов можно командой `ps`, параметр `-ef` - все процессы.
Команда `pstree -p` выводит в древовидном стиле, удобно смотреть дочерние процессы.
Процессы всегда находятся в одном из нескольких состояний.
Следующая команда показывает список процессов более подробно
```bash
ps -eo pid,user,stat,comm
```
Состояния процессов (не полное `man 1 ps`)
| Состояние | Описание                                                    |
| --------- | --------                                                    |
| R         | Процесс выполняется или ожидает своей очереди на выполнение |
| l         | Многопоточный процесс                                       |
| S         | Находится в состоянии ожидания события                      |
| s         | Лидер сеанса. Сеанс - группа родственных процессов          |
| I         | Поток бездействия ядра                                      |
| <         | Высокий приоритет                                           |
| N         | Низкий приоритет                                            |

## Вывод списка служб и их состояний с помощью команды systemctl
Команда `systemctl` это команда-диспечер `systemd`.
Если запустить ее без параметров, она выведет все загруженные модули.
Модуль `systemd` это любой пакет процессов, связанных друг с другом, определенных
в файле конфигурации модуля.
`systemctl` может выводить не активные и отсутствующие модули.
Следующая команда выводит полный список файлов модулей
```bash
systemctl list-unit-files
```
Выводит только список служб
```bash
systemctl list-unit-files --type=service
```
Состояние служб
| State    | Описание        |
| ------   | --------        |
| enabled  | Служба включена |
| disabled | Выключена       |
| static   | Статическая     |
| masked   | Маскированная   |
Следующая команда покажет список включенных служб
```bash
systemctl list-unit-files --type=service --state=enabled
```
Файлы служб модулей находятся в _/usr/lib/systemd/system_ или _/lib/systemd/system_.
Когда служба включена, `systemd` создаёт символическую ссылку в _/etc/systemd/system/_ на
файл модуля в _/lib/systemd/system_.
Включение службы не приводит к её запуску, а отключение к остановке.
Статус `disabled` означает, что в _/etc/systemd/system_ нет символической ссылки.
Статус `masked` говорит о том, что служба ссылается на _/dev/null/_, она полностью отключена.
Статус `static` означает, что файл модуля является зависимостью другого файла модуля.
Статус `indirect` управляются только службами.
Статус `generated` преобразована из другой системы инициализации.

## Определение состояния выбранных служб
Команда `systemctl status` выводит полезную информацию о состоянии службы.
`Loaded` загружен ли файл модуля в память и полный путь к нему. Этот параметр отражает
предпочтения производителя и не сообщает включена ли служба в настоящее время.
`Active` активна ли служба и как долго.
`Process` выводит PID процесса, команды и имена доменов.
`Main PID` номер процесса для сегмента контрольной группы.
`Tasks` количество задач запущенных службой.
`CGroup` показывает, к какому сегменту модуля принадлежит служба и его PID.
Контрольные группы Linux (cgroups) - это наборы связанных процессов и всех его потомков.
Сегмент в `systemd` - это часть контрольной группы и каждый сегмент управляет отдельной
группой процессов.
Службы и области видимости модулей сгруппированы в _/lib/systemd/system/system.slice_.
Пользовательские сеансы сгруппированы в _/lib/systemd/system/user.slice_.
Виртуальные машины и контейнеры в _/lib/systemd/system/machine.slice_.
Остальные строки - это последние записи в журнале из команды `journalctl`.
Команда `journalctl` - это диспечер журналов в `systemd`.

## Запуск и остановка служб
