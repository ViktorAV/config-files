# Глава 2. Управление загрузчиком GRUB
> Загрузчик это программа, загружающая операционную систему
> после включения компьютера.

Загрузчик __GRUB__ поддерживает
- Загрузку нескольких операционных систем.
- Редактирование конфигурации в реальном времени.
- Настройку интерфейса.
- Режимы восстановления.
Существуют две основные версии __GRUB__: устаревшая __GRUB__ и 
более новая __GRUB 2__, когда упоминается __GRUB__, подразумевается вторая версия.

В современной архитектуре ПК x86_64 начальные инструкции запуска хранятся в
микросхеме на материнской плате.
Процессор жёстко запрограммирован на получение начальных инструкций из
определённого адреса. (адрес - reset vector)

После включения электро питания
- Процессор извлекает инструкции из микропрограммы __BIOS__ или __UEFI__.
- Инициализурет системные кэши.
- Инициализирует системную память.
- Выполняется процедура самотестирования (POST).
  - Проверяется память.
  - Проверяется наличие другого оборудования. (клавиатура, мышь, дисплей, диски)
- Поиск и выполнение загрузчика. (__GRUB__)
  - Загружает файлы, необходимые для запуска операционной системы.
  - Выводит загрузочное меню.
    Клавиша `Shift` в момент загрузки, также выводит это меню.
  - Ждёт ввода некоторое время.
    Если ничего не делать это время, __GRUB__ просто загрузит систему.

## Повторная сборка конфигурационного файла GRUB
Команды сборки GRUB в дистрибутивах могут различаться.
Команда для Fedora и openSUSE
```bash
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```
Команда в Ubuntu
```bash
sudo grub-mkconfig -o /boot/grub/grub.cfg
sudo update-grub # тоже самое что grub-mkconfig
```

## Отображение скрытого меню GRUB
Чтобы отобразить это меню, в начале загрузки системы удерживайте клавишу `Shift`.

Отредактируйте файл _/etc/default/grub_ (путь зависит от дистрибутива)
```bash
GRUB_TIMEOUT="10"
GRUB_TIMEOUT_STYLE=menu
```
Если присутсвтуют следущие строки, закомментируйте их, символом `#`
```bash
GRUB_HIDDEN_TIMEOUT=0 # Запрещает отображение меню.
GRUB_HIDDEN_TIMEOUT_QUIET=true # Запрещает отображение таймера.
```
Пересоберите конфигурацию __GRUB__.

## Загрузка с другим ядром Linux
С течением времени система Linux обновляется, но старые ядра Linux остаются в системе.
Старые ядра можно удалять или загружать, если что-то пойдет не так в новом ядре.


## Устройство конфигурационных файлов GRUB
- _/etc/default/grub_
  Содержит настройки
  - Внешнего вида __GRUB__.
  - Скрытие или отображение загрузчика.
  - Время ожидания.
  - Параметры ядра.
  ```bash
  GRUB_DEFAULT=0 # Пункт загрузки по умолчанию. (не нумеруются явно)
  GRUB_DEFAULT=saved # Сохраняет последний выбранный пункт.
  GRUB_SAVEDEFAULT=true # Нужно, если GRUB_DEFAULT=saved
  GRUB_TIMEOUT=10 # Время ожидания выбора пунтка загрузки в секундах.
  GRUB_TIMEOUT_STYLE=menu # Отображает строку отчета времени ожидания.
  GRUB_CMDLINE_LINUX= # Добавляет параметры ядра, для всех пунктов меню.
  GRUB_CMDLINE_LINUX_DEFAULT= # Определяет парамеры ядра, только для выбраного пункта.
  GRUB_TERMINAL=gfxterm # Устанавливает графический режим отображения меню.
  GRUB_TERMINAL=console # Отключает графический режим.
  GRUB_GFXMODE=1024x768 # Разрешение экрана в графическом режиме.
  GRUB_BACKGROUND= # Устанавливает фоновое изображение.
  GRUB_THEME= # Устанавливает тему оформления.
  ```
- _/etc/grub.d/_
  Содержит более сложные файлы конфигурации.
  Каждый файл является сценарием и имеет разрешение на выполнение. (`chmod`)
  Чтобы отключить выполнение файла, используйте команду
  ```bash
  sudo chmod -x filename # забрать права на выполнение файла.
  ```
    Содержание файлов, начальные цифры определяют приоритет загрузки.
    - 00_headers
    - 01_users
    - 08_fallback_counting
    - 10_linux
    - 10_reset_boot_success
    - 12_menu_auto_hide
    - 20_linux_xen
    - 20_ppc_terminfo
    - 30_os-prober
    - 30_uefi_firmware
    - 40_custom
    - 41_custom
    - backup
    - README
- _/boot/grub_
  Хранит файлы изображений и оформлений для меню __GRUB__.
  _/grub.cfg_
    Главный конфигурационный файл, читает его при запуске.
    Этот файл нельзя редактировать.

## Настройка фонового изображения меню GRUB
Разрешимые форматы изображения - `JPG` `PNG` `TFA`.
Размер изображения может быть любым, __GRUB__ автоматически масштабирует его.
Изображение должно находится в каталоге _/boot/grub_, чтобы независимо от загруженной
системы у нас был доступ к изображению.
Необходимо добавить путь к файлу изображения в _/etc/default/grub_.
```bash
GRUB_BACKGROUND="/boot/grub/image.jpg"
# GRUB_THEME= # эта строка должна быть закоментирована.
```
Вы должны увидеть сообщение `Found background: /boot/grub/file.jpg`, в
выводе команды сборки, если сообщения не появилось, что-то пошло не так.

## Изменение цвета шрифтов в GRUB
Поддерживаемые цвета
`black blue brown cyan dark-gray green light-cyan light-blue yellow`
`light-green light-gray light-magneta light-red magneta red white`
### В командной строке, без сохранения изменений
Когда появится меню __GRUB__ нажмите клавишу `C` чтобы открыть командную строку.
Введите следующие команды
```bash
menu_color_highlight=cyan/blue # цвет шрифта/фона для выбранной строки.
menu_color_normal=yellow/black # цвет шрифта/фона цвет black для фона - прозрачный.
```
Нажмите `Enter` затем `Esc` чтобы вернуться в меню и посмотреть результаты.

### Сохраняем изменения
Создайте новый сценарий в каталоге _/etc/grub.d/_, например 07_font_colors.
Поместите туда следующий текст
```bash
#!/bin/sh

  if [ "x${GRUB_BACKGROUND}" != "x"] ; then
    if [ "x${GRUB_COLOR_NORMAL}" != "x" ] ; then
    echo "set menu_color_normal=${GRUB_COLOR_NORMAL}"
    fi
    
    if [ "x${GRUB_COLOR_HIGHLIGHT}" != "x" ] ; then
    echo "set menu_color_highlight=${GRUB_COLOR_HIGHLIGHT}"
    fi
  fi
```
Дайте этому файлу права на выполнение
```bash
sudo chown +x /etc/grub.d/07_fonts_colors
```
Добавьте следующие строки в файл _/etc/default/grub_ для определения цветов
```bash
export GRUB_COLOR_NORMAL="yellow/black"
export GRUB_COLOR_HIGHLIGHT="cyan/blue"
```
Пересоберите конфигурацию __GRUB__, команда `grub-mkconfig` или `update-grub`
После перезагрузки компьютеры появится результат.

## Применение темы оформления к меню GRUB
Найти темы можно командой
```bash
apt search theme | grep grub
```
Загрузка выполняется так-же как и загрузка пакетов.
Новые темы должны устанавливаться в каталог _/boot/grub/themes_.
Чтобы выбрать тему, добавьте следующую строку в файл _/etc/default/grub_
```bash
GRUB_THEME=/boot/grub/themes/theme-name/theme.txt
# GRUB_BACKGROUND # и прочие определения цветов должны быть закомментированы.
```
В выводе команды вы должны увидеть строку `Found theme: /boot/grub/themes/theme ...`
если её не появилось, что-то пошло не так.
Чтобы увидеть результат выполните перезагрузку.

## Восстановление незагружающейся системы из приглашения grub>
Если процесс загрузки останавливатся на приглашении ввода `grub>`, это означает
что загрузчик нашёл каталог _/boot/grub_, но не может найти файловую систему.
Вам необходимо найти файловую систему, ядро, файл _initrd_ из командной оболочки __GRUB__.
Следующая команда помогает смотреть длинный вывод, постранично
```bash
set pager=1
```
Команда `ls` показывает идентификаторы всех подключенных устройств.
Команда `ls (hd0,3)` выводит тип и другую информацию выбранного устройства.
Команда `ls (hd0,2)/` выводит список всех файлов и каталогов выбранного устройства.
Команда `ls (hd0,2)/boot` выводит все загрузочные файлы выбранного устройства.
Установите раздел корневой файловой системы, ядро и образ __initrd__
```bash
set root=(hd0,2)
linux /boot/vmzlinuz-5.3.18-lp152.57-default root=/dev/sda2
initrd /boot/initrd-5.3.18-lp152.57-default
```
Теперь можно загружаться командой `boot`.

## Восстановление незагружающейся файловой системы из приглашения grub rescue>
Если загрузка системы останавливается на `grub rescue>`.
Это означает что загрузчик не нашел каталог _/boot_.
Выводим список разделов командой `ls`.
Команда `ls (hd0,3)` выводит дополнительную информацию о разделе.
Посмотрите все разделы командой `ls (hd0,3)/` чтобы найти каталог _/boot_.
Команда `ls (hd0,2)/boot` выводит доступные загрузчики.
Выполните следующие команды
```bash
set prefix=(hd0,2)/boot/grub # указываем где находится каталог grub
set root=(hd0,2)
insmod normal # изменяет режим с аварийного на нормальный, включает дополнения Tab
insmod linux # запускает системный загрузчик, включает дополнения клавишей Tab
set pager=1 # включает прокрутку вывода
# Установка ядра и образа __initrd__
linux /boot/vmzlinuz-5.3.18-lp152.57-default root=/dev/sda2
initrd /boot/initrd-5.3.18-lp152.57-default
boot # Загружаемся
```

## Переустановка конфигурации GRUB
Перед переустановкой рекомендуется создать резервную копию.
```bash
sudo grub-mkconfig -o /boot/grub/grub.cfg
sudo grub-install /dev/sda
```
