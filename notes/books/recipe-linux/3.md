# Запуск, остановка, перезапуск и перевод Linux в спящий режим
Комбинация клавиш `Ctrl+Alt+Delete` завершает процесс.
Устаревшие команды выключения компьютера, могут требоваться права __root__
```bash
shutdown # поддерживает дополнительные параметры, предупреждение, таймер
halt
poweroff
reboot
```
В системах Linux с __systemd__ эти команды не устанавливаются, все они используют
символическую ссылку на команду `systemctl`.
Команда `stat /sbin/shutdown` поможет в этом убедиться.


## Выключение с помощью команды systemctl
Остановить систему и выключить электропитание можно этими командами
```bash
systemctl poweroff
systemctl shutdown
systemctl reboot
systemctl halt
```
Команды `systemctl` не поддерживают ряд параметров от старых команд.

## Выключение, выключение по времени и перезагрузка с помощью команды shutdown
Параметры команды `shutdown` по умолчанию - `shutdown -h +1`.
Немедленно выключить компьютер, без уведомления других пользователей
```bash
shutdown -h now
```
Выключение через 10 минут с уведомлением других пользователей
```bash
shutdown -h +10
```
Отмена выключения
```bash
shutdown -c
```
Как будут выглядеть сообщения
```bash
Broadcast message from mail@client on pts/4 (date):
The system shutdown has been cancelled
```
Послать своё сообщение можно так
```bash
shutdown -h +6 "message"
```
Так-же можно указать точное время выключения
```bash
shutdown -h 23:45
```
Перезагрузка системы
```bash
shutdown -r
```
Остановка системы без выключения электропитания
```bash
shutdown -H
```

## Выключение и перезагрузка с помощью команд halt, reboot и poweroff
Все эти команды действуют почти одинково.
Команда `halt` завершает работу системы, останавливает все службы и процессы,
и размонитрует все файловые системы, но не выключает компьютер.
Команда `reboot` завершает работу системы и перезагружает компьютер.
Команда `poweroff` завершает работу системы и выключает компьютер.
Команды `halt` и `poweroff` так-же могут перезагружать компьютер, добавив параметр
`--reboot`.

## Перевод системы в спящий режим
Система Linux имеет __systemd__, её можно перевести в спящий режим командой `systemctl`.
Команда `systemctl` поддерживает следующие режимы энергосбережения
- `suspend`
- `hibernate`
- `hybrid-sleep`
- `suspend-then-hibernate`
Следующая команда переводит систему в режим приостановки
```bash
systemctl suspend
```
Текущий сеанс останется в ОЗУ, а аппаратное обеспечение будет переведено в режим
пониженного энергопотребления. Нажмите любую клавишу чтобы выйти из этого режима.
Следующая команда переведет систему в спящий режим
```bash
systemctl hibernate
```
Текущий сеанс сбрасывается на диск и выключается питание.
Следующая команда переводит систему в гибридный спящий режим
```bash
systemctl hybrid-sleep
```
Текущий сеанс останется в ОЗУ и сбрасывается на диск, все устройства кроме ОЗУ выключаются.
Следующая команда переводит систему в режим приостановки и потом в спящий режим
```bash
systemctl suspend-then-hibernate
```
Параметр `HibernateDelaySec=` в файле _/etc/systemd/sleep.conf_ определяет время, после
которого система перейдет в спящий режим.

## Надёжная перезагрузка с помощью комбинации Ctrl+Alt+Delete
Эта комбинация управляется демоном `systemd`.
Если ваш Linux не имеет `systemd`, эта комбинация настраивается в файле _/etc/inittab_

## Включение, выключение и настройка комбинации Ctrl+Alt+Delete в консоли Linux
Поведением этой комбинации управляет __systemd__.
Файл этого модуля не является службой.
Комбинация доступна если существует ссылка _/etc/sytemd/system/ctrl-alt-del.target_.
Следущий пример, выключает и маскирует комбинацию
```bash
sudo systemctl disable ctrl-alt-del.target
sudo systemctl mask ctrl-alt-del.target
```
Размаскировывание и включение
```bash
sudo systemctl unmask ctrl-alt-del.target
sudo systemctl enable ctrl-alt-del.target
```
Изменение команды с перезагрузки на выключение, для комбинации
```bash
sudo systemctl disable ctrl-alt-del.target
sudo ln -s /lib/systemd/system/poweroff.target \
  /etc/systemd/system/ctrl-alt-del.target
```
Не изменяйте существующие ссылки, создавайте новые, чтобы при обновлении системы они
не удалились.


## Выключение по расписанию с помощью cron
Добавьте в файл _/etc/crontab_ (требуются права __root__)
```bash
# мин час дм мес дн   пользователь команда
  00  23  *  *   1-5  root	   /sbin/shutdown -h now
```
Допустимые параметры
| Поле              | Допустимые значения         |
| ----------------- | -------------------         |
| мин (Минуты)      | 0-59                        |
| час (Часы)        | 0-23                        |
| дм  (День месяца) | 1-31                        |
| мес (месяц)       | 1-12                        |
| дн  (День недели) | 0-7                         |
|                   | * (Все или любой)           |
|                   | 1-5 (Диапозон от 1 до 5)    |
|                   | */2 (Дипазон каждый второй) |
Команда `crontab` создает новый файл с расписанием, который не требует парава __root__.

## Автоматическое включение по расписанию с помощью UEFI
Настраивается в параметрах UEFI.

## Автоматическое включение по расписанию с помощью часов реального времени
real-time clock (RTC)
В файле _/sys/power/state_ содержатся доступные режимы сна, выведем
```bash
cat /sys/power/state
cat /proc/acpi/info # для систем без systemd
```
Используйте команду `rtcwake` которая находится в пакете `util-linux`.
```bash
sudo rtcwake -m freeze -s 60
```
`-m` Задаёт режим сна.
`-s` Количество секунд до повторного запуска системы.
Следующий пример переводит систему в режим сна и пробуждает завтра в 8:00
```bash
sudo rtcwake -m disk no -u -t $(date +%s -d "tommorow 08:00")
```
Удалите параметр `-t` чтобы выполнить команду не в тестовом режиме.
Изменим `crontab`. в 23:00 по будням `rtcwake` останавливает работу системы с сохранением
состояния на диск и запускает ее спустя 8 часов.
```bash
# мин час дм мес дн   пользователь команда
  00  23  *  *   1-5  root 	   /usr/sbin/rtcwake -m disk -s 28800
```

## Настройка удалённого включения по сети с помощью проводного Ethernet 
Выводит компьютер из спящего режима.
Включите параметр `Wake-on-LAN` в настройках __UEFI__, если он есть.
Установите пакеты `wakeonlan` и `ethtool`.
Узнайте имя вашего интерфейса __Ethernet__ 
```bash
ip addr show
```
Запишите __MAC-адрес__ из строки __ether__.
Проверьте поддерживает ли ваш интерфейс __Ethernet__, включение по сети
```bash
sudo ethtool enp0s25 | grep -i wake-on
```
Если `wake-on` не имеет значения `g`, включите его
```bash
sudo ethtool -s enp0s25 wol g
```
Если после перезагрузки изменения не сохранятся, добавьте в файл _/etc/crontab_
```bash
@reboot root /usr/bin/ethtool -s enp0s25 wol g
```
Выключите компьютер и отправьте команду со второго устройства
```bash
/usr/bin/wakeonlan 9c:ef:d5:fe:8f:20 # MAC-адрес
```
Если устройство находится в другой подсети
```bash
/usr/bin/wakeonlan -i 192.168.44.255 9c:ef:d5:fe:8f:20 # MAC-адрес
```


## Настройка удалённого включения через Wi-Fi (WoWLAN)
Включите параметр `Wake-on-LAN` в настройках __UEFI__ если имеется.
Выведите список всех беспроводных устройств и запишите __MAC-адрес__
```bash
iw dev
```
Проверьте включена ли функция __wowlan__
```bash
iw phy0 wowlan show
```
Включите функцию __wowlan__ если она отключена
```bash
sudo iw phy0 wowlan enable magic-packet
```
Использование
```bash
/usr/bin/wakeonlan mac-адрес
```
Использование для другой подсети
```bash
/usr/bin/wakeonlan -i 192.168.0.1 mac-адрес
```
