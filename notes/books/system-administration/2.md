# Загрузка и системные демоны
Загрузка (booting) - означает запуск компьютера, представляет собой сокращённую форму слова
самозагрузка (bootstrapping), процесс загрузки состоит из нескольких задач
- Поиск, ввод в память и запуск кода начальной загрузки.
- Поиск, ввод в память и запуск ядра операционной системы.
- Активирование сценариев запуска и системных демонов.
- Поддержание порядка управления переходами системы из одного состояния в другое.
  Этот пункт выполняется и после загрузки системы.

## Обзор процесса загрузки
Мененджер __systemd__ в отличие от __init__ упращает процесс загрузки
- Добавляет управление зависимости.
- Поддерживает одновременный запуск процессов.
- Комплексно подходит к протоколированию.
Во время начальной загрузки ядро загружается в память и начинает выполняться.
При этом выполняется множество задач инициализации и затем система становится доступной.
- Загружается BIOS/UEFI из NVRAM.
- Собираются сведения об аппаратуре.
- Выбирается устройство для запуска. (диск, сеть, ...)
- Идентифицируется системный раздел EFI.
- Выполняется загрузчик. (GRUB, ...)
- Определяется ядро для загрузки.
- Ядро загружается.
- Создаются структуры данных ядра.
- Запускается init/systemd с PID 1.
- Выполняются сценарии запуска.
- Система запускается.
Администраторы не имеют доступа к большинству из этих действий.
Но мы можем изменять конфигурации загрузчиков
- Редактировать файлы конфигурации для сценариев запуска системы.
- Изменять аргументы которые загрузчик передаёт ядру.
Прежде чем система будет полностью загружена, должны быть проверены и смонтированы файловые
системы и запущены системные демоны. Этими процедурами управляет набор сценариев оболочки,
либо файлы, которые запускает __init__ или __systemd__.

### Системные прошивки
При включении компьютера, процессор выполняет загрузочный код.
Прошивка системы, знает обо всех устройствах, которые подключены к материнской плате
- Контроллеры SATA.
- Сетевые интерфейсы.
- USB-контроллеры.
- Датчики питания и температуры.
Помимо возможности настройки этих устройств, прошивка позволяет вам либо сообщить о них
операционной системы, либо отключить и скрыть их.
Для работы с этим необходимо нажать на определённую клавишу при загрузке системы.

### BIOS или UEFI прошивка
BIOS (Basic Input / Output System) был вытеснен более современным UEFI.
UEFI это следущая версия EFI.

#### Устаревший интерфейс BIOS
Предполагает что, загрузочное устройство начинается с записи (сектора) MBR (Master Boot Record)
MBR содержит первичный загрузчик и простую таблицу разделов диска.
Объём свободного места для загрузки 512 байт.
Он не может выполнять ничего кроме загрузки и запуска вторичного загрузчика.
MBR ничего не знает об операционной системе.

### UEFI
Спецификация UEFI включает в себя современную схему разделения диска GPT.
Умеет работать с файловой системой FAT(File Allocation Table) простая и функциональная схема.
Во время загрузки обращается к таблице разделов GPT для идентификации ESP.
Затем она считывает настроенное целевое приложение из файла в ESP и выполняет его.
ESP представляет собой общую файловую систему FAT.
Интерфейс UEFI сохраняет имя пути для загрузки из ESP в качестве параметра конфигурации.
Если этот параметр не задан, используется стандартный путь `/efi/boot/bootx64.efi` или
`/efi/ubuntu/grubx64.efi`.
Интерфейс UEFI определяет стандартные интерфейсы API для доступа к аппаратным средствам ОС.
Переменные UEFI можно смотреть и изменять в уже загруженной системе.
Команда __efibootmgr__ `-v` выводит конфигурацию загрузки.

## Загрузчики
Оснавная задача загрузчика - определить и загрузить ядро операционной системы.
Большиство загрузчиков предоставляют интерфейс для выбора ядра загрузки.
Другая задача загрузчика - маршалинг аргументов конфигурации ядра.

### GRUB универсальный загрузчик
GRUB (GRand Unified Boot) имеет два направления GRUB Legacy и новый GRUB 2.
Позволяет указать в параметрах загрузочное ядро и режим работы для загрузки.
Конфигурационный файл называется `grub.cfg` который хранится в `/boot/grub` или `/boot/grub2`.
Команда для генерации файла конфига __grub-mkconfig__ или __grub2-mkconfig__ или __update-grub__.
Чаще всего конфигурация задаётся в файле `/etc/default/grub` в виде sh.
| Переменная            | Содержимое                                                |
| GRUB BACKGROUND       | Фоновое изображение                                       |
| GRUB_CMDLINE_LINUX    | Параметры ядра для добавления в записи меню для Linux     |
| GRUB DEFAULT          | Номер или название элемента меню по умолчанию             |
| GRUB DISABLE RECOVERY | Предотвращает создание записей режима восстановления      |
| GRUB_PRELOAD_MODULES  | Приоритетный список модулей GRUB                          |
| GRUB TIMEOUT          | Секунды для отображения меню загрузки перед автозагрузкой |
После редактирования `/etc/default/grub` запустите команду __grub-mkconfig__.
Файл `/etc/grub.d/40_custom` может изменить порядок, в котором ядра указаны в меню загрузки,
установить пароль для загрузки или изменить имена меню загрузки. __grub-mkconfig__.

#### Командная строка GRUB




